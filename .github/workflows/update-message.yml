name: æ›´æ–°ç½®é¡¶æ¶ˆæ¯

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'è¯·è¾“å…¥è¦ç½®é¡¶æ˜¾ç¤ºçš„å†…å®¹'
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-message:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          
      - name: è·å–å½“å‰åŒ—äº¬æ—¶é—´
        id: get-time
        run: |
          echo "datetime=$(date '+%Y-%m-%d-%H-%M-%S')" >> $GITHUB_OUTPUT
          echo "formatted_time=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_OUTPUT
          
      - name: åˆ›å»ºå½’æ¡£æ–‡ä»¶
        run: |
          # åˆ›å»ºå½’æ¡£ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p archives
          
          # åˆ›å»ºå½’æ¡£markdownæ–‡ä»¶
          cat > "archives/${{ steps.get-time.outputs.datetime }}.md" << 'EOF'
          # ç½®é¡¶æ¶ˆæ¯å½’æ¡£

          **æ—¶é—´**: ${{ steps.get-time.outputs.formatted_time }} (åŒ—äº¬æ—¶é—´)

          **å†…å®¹**:

          ${{ github.event.inputs.message }}
          EOF
          
      - name: æ›´æ–°README.md
        run: |
          # è¯»å–ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
          MESSAGE="${{ github.event.inputs.message }}"
          TIME="${{ steps.get-time.outputs.formatted_time }}"
          
          # åˆ›å»ºæ–°çš„ç½®é¡¶å†…å®¹
          NEW_PINNED="<!-- PINNED-MESSAGE-START -->\n## ğŸ“Œ ç½®é¡¶æ¶ˆæ¯\n\n> $MESSAGE\n\n*æ›´æ–°æ—¶é—´: $TIME (åŒ—äº¬æ—¶é—´)*\n<!-- PINNED-MESSAGE-END -->"
          
          # æ£€æŸ¥READMEæ˜¯å¦å­˜åœ¨
          if [ -f README.md ]; then
            # è¯»å–ç°æœ‰READMEå†…å®¹
            README_CONTENT=$(cat README.md)
            
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç½®é¡¶æ ‡è®°
            if grep -q "<!-- PINNED-MESSAGE-START -->" README.md; then
              # æ›¿æ¢ç°æœ‰çš„ç½®é¡¶å†…å®¹
              sed -i '/<!-- PINNED-MESSAGE-START -->/,/<!-- PINNED-MESSAGE-END -->/c\<!-- PINNED-MESSAGE-START -->\n## ğŸ“Œ ç½®é¡¶æ¶ˆæ¯\n\n> '"$MESSAGE"'\n\n*æ›´æ–°æ—¶é—´: '"$TIME"' (åŒ—äº¬æ—¶é—´)*\n<!-- PINNED-MESSAGE-END -->' README.md
            else
              # åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ç½®é¡¶å†…å®¹
              echo -e "$NEW_PINNED\n\n$(cat README.md)" > README.md
            fi
          else
            # åˆ›å»ºæ–°çš„READMEæ–‡ä»¶
            echo -e "$NEW_PINNED\n\n<!-- åœ¨è¿™é‡Œæ·»åŠ ä»“åº“ä»‹ç»ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¸ä¼šè¢«Actionsä¿®æ”¹ -->" > README.md
          fi
          
      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add README.md
          git add archives/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "æ›´æ–°ç½®é¡¶æ¶ˆæ¯ - ${{ steps.get-time.outputs.formatted_time }}"
            git push
          fi
